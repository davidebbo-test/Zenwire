<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\projects\zenwire\zenwire\extensions\dbcontextextensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Data.Entity;
using System.Data.Entity.Infrastructure;
using System.Data.Metadata.Edm;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Reflection;

namespace Zenwire.Extensions
{
    [ExcludeFromCodeCoverage]
    public static class DbContextExtensions
    {
        public static T AddOrUpdate&lt;T&gt;(this DbContext context, T entity)
            where T : class
        {
            if (context == null) throw new ArgumentNullException(&quot;context&quot;);
            if (entity == null) throw new ArgumentNullException(&quot;entity&quot;);

            if (IsTransient(context, entity))
            {
                context.Set&lt;T&gt;().Add(entity);
            }
            else
            {
                context.Set&lt;T&gt;().Attach(entity);
                context.Entry(entity).State = EntityState.Modified;
            }
            return entity;
        }

        public static bool IsTransient&lt;T&gt;(this DbContext context, T entity)
            where T : class
        {
            if (context == null) throw new ArgumentNullException(&quot;context&quot;);
            if (entity == null) throw new ArgumentNullException(&quot;entity&quot;);

            var propertyInfo = FindPrimaryKeyProperty&lt;T&gt;(context);
            var propertyType = propertyInfo.PropertyType;
            //what&#39;s the default value for the type?
            var transientValue = propertyType.IsValueType ?
                Activator.CreateInstance(propertyType) : null;
            //is the pk the same as the default value (int == 0, string == null ...)
            return Equals(propertyInfo.GetValue(entity, null), transientValue);
        }

        public static T Load&lt;T&gt;(this DbContext context, object id)
             where T : class
        {
            if (context == null) throw new ArgumentNullException(&quot;context&quot;);
            if (id == null) throw new ArgumentNullException(&quot;id&quot;);

            var property = FindPrimaryKeyProperty&lt;T&gt;(context);
            //check to see if it&#39;s already loaded (slow if large numbers loaded)
            var entity = context.Set&lt;T&gt;().Local
                .FirstOrDefault(x =&gt; id.Equals(property.GetValue(x, null)));
            if (entity == null)
            {
                //it&#39;s not loaded, just create a stub with only primary key set
                entity = CreateEntity&lt;T&gt;(id, property);

                context.Set&lt;T&gt;().Attach(entity);
            }
            return entity;
        }

        public static bool IsLoaded&lt;T&gt;(this DbContext context, object id)
            where T : class
        {
            if (context == null) throw new ArgumentNullException(&quot;context&quot;);
            if (id == null) throw new ArgumentNullException(&quot;id&quot;);

            var property = FindPrimaryKeyProperty&lt;T&gt;(context);
            //check to see if it&#39;s already loaded (slow if large numbers loaded)
            var entity = context.Set&lt;T&gt;().Local
                .FirstOrDefault(x =&gt; id.Equals(property.GetValue(x, null)));
            return entity != null;
        }

        public static void MarkReferencesUnchanged&lt;T&gt;(DbContext context, T entity)
            where T : class
        {
            var objectContext = ((IObjectContextAdapter)context).ObjectContext;
            var objectSet = objectContext.CreateObjectSet&lt;T&gt;();
            var elementType = objectSet.EntitySet.ElementType;
            var navigationProperties = elementType.NavigationProperties;
            
            //the references
            var references = from navigationProperty in navigationProperties
                             let end = navigationProperty.ToEndMember
                             where end.RelationshipMultiplicity == RelationshipMultiplicity.ZeroOrOne ||
                             end.RelationshipMultiplicity == RelationshipMultiplicity.One
                             select navigationProperty.Name;
            
            //NB: We don&#39;t check Collections. EF wants to handle the object graph.
            var parentEntityState = context.Entry(entity).State;
            foreach (var navigationProperty in references)
            {
                //if it&#39;s modified but not loaded, don&#39;t need to touch it
                if (parentEntityState == EntityState.Modified &amp;&amp;
                    !context.Entry(entity).Reference(navigationProperty).IsLoaded)
                    continue;
                var propertyInfo = typeof(T).GetProperty(navigationProperty);
                var value = propertyInfo.GetValue(entity, null);
                context.Entry(value).State = EntityState.Unchanged;
            }
        }

        public static T Merge&lt;T&gt;(this DbContext context, object dataTransferObject)
             where T : class
        {
            if (context == null) throw new ArgumentNullException(&quot;context&quot;);
            if (dataTransferObject == null) throw new ArgumentNullException(&quot;dataTransferObject&quot;);

            var property = FindPrimaryKeyProperty&lt;T&gt;(context);
            //find the id property of the dto
            var idProperty = dataTransferObject.GetType().GetProperty(property.Name);
            if (idProperty == null)
                throw new InvalidOperationException(&quot;Cannot find an id on the dataTransferObject&quot;);
            var id = idProperty.GetValue(dataTransferObject, null);
            //has the id been set (existing item) or not (transient)?
            var propertyType = property.PropertyType;
            var transientValue = propertyType.IsValueType ?
                Activator.CreateInstance(propertyType) : null;
            var isTransient = Equals(id, transientValue);
            T entity;
            if (isTransient)
            {
                //it&#39;s transient, just create a dummy
                entity = CreateEntity&lt;T&gt;(id, property);
                //if DatabaseGeneratedOption(DatabaseGeneratedOption.None) and no id, this errors
                context.Set&lt;T&gt;().Attach(entity);
            }
            else
            {
                //try to load from identity map or database
                entity = context.Set&lt;T&gt;().Find(id);
                if (entity == null)
                {
                    //could not find entity, assume assigned primary key
                    entity = CreateEntity&lt;T&gt;(id, property);
                    context.Set&lt;T&gt;().Add(entity);
                }
            }
            //copy the values from DTO onto the entry
            context.Entry(entity).CurrentValues.SetValues(dataTransferObject);
            return entity;
        }


        private static PropertyInfo FindPrimaryKeyProperty&lt;T&gt;(IObjectContextAdapter context)
            where T : class
        {
            //find the primary key
            var objectContext = context.ObjectContext;
            //this will error if it&#39;s not a mapped entity
            var objectSet = objectContext.CreateObjectSet&lt;T&gt;();
            var elementType = objectSet.EntitySet.ElementType;
            var pk = elementType.KeyMembers.First();
            //look it up on the entity
            var propertyInfo = typeof(T).GetProperty(pk.Name);
            return propertyInfo;
        }

        private static T CreateEntity&lt;T&gt;(object id, PropertyInfo property)
            where T : class
        {
            // consider IoC here
            var entity = (T)Activator.CreateInstance(typeof(T));
            //set the value of the primary key (may error if wrong type)
            property.SetValue(entity, id, null);
            return entity;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,10,0],[18,13,18,33,0],[18,34,18,77,0],[19,13,19,32,0],[19,33,19,75,0],[21,13,21,46,0],[22,13,22,14,0],[23,17,23,46,0],[24,13,24,14,0],[26,13,26,14,0],[27,17,27,49,0],[28,17,28,68,0],[29,13,29,14,0],[30,13,30,27,0],[31,9,31,10,0],[35,9,35,10,0],[36,13,36,33,0],[36,34,36,77,0],[37,13,37,32,0],[37,33,37,75,0],[39,13,39,67,0],[40,13,40,58,0],[42,13,43,63,0],[45,13,45,80,0],[46,9,46,10,0],[50,9,50,10,0],[51,13,51,33,0],[51,34,51,77,0],[52,13,52,28,0],[52,29,52,67,0],[54,13,54,63,0],[56,13,57,38,0],[57,75,57,77,0],[58,13,58,32,0],[59,13,59,14,0],[61,17,61,56,0],[63,17,63,49,0],[64,13,64,14,0],[65,13,65,27,0],[66,9,66,10,0],[70,9,70,10,0],[71,13,71,33,0],[71,34,71,77,0],[72,13,72,28,0],[72,29,72,67,0],[74,13,74,63,0],[76,13,77,38,0],[77,75,77,77,0],[78,13,78,35,0],[79,9,79,10,0],[83,9,83,10,0],[84,13,84,80,0],[85,13,85,64,0],[86,13,86,63,0],[87,13,87,73,0],[90,13,91,34,0],[94,60,94,61,0],[97,13,97,65,0],[98,13,98,20,0],[98,48,98,58,0],[98,22,98,44,0],[99,13,99,14,0],[101,17,102,83,0],[103,21,103,30,0],[104,17,104,78,0],[105,17,105,65,0],[106,17,106,68,0],[107,13,107,14,0],[98,45,98,47,0],[108,9,108,10,0],[112,9,112,10,0],[113,13,113,33,0],[113,34,113,77,0],[114,13,114,44,0],[114,45,114,99,0],[116,13,116,63,0],[118,13,118,86,0],[119,13,119,36,0],[120,17,120,100,0],[121,13,121,68,0],[123,13,123,54,0],[124,13,125,63,0],[126,13,126,58,0],[128,13,128,29,0],[129,13,129,14,0],[131,17,131,56,0],[133,17,133,49,0],[134,13,134,14,0],[136,13,136,14,0],[138,17,138,52,0],[139,17,139,36,0],[140,17,140,18,0],[142,21,142,60,0],[143,21,143,50,0],[144,17,144,18,0],[145,13,145,14,0],[147,13,147,79,0],[148,13,148,27,0],[149,9,149,10,0],[154,9,154,10,0],[156,13,156,55,0],[158,13,158,64,0],[159,13,159,63,0],[160,13,160,53,0],[162,13,162,63,0],[163,13,163,33,0],[164,9,164,10,0],[168,9,168,10,0],[170,13,170,65,0],[172,13,172,49,0],[173,13,173,27,0],[174,9,174,10,0],[91,34,91,70,0],[92,36,93,90,0],[94,37,94,60,0],[57,38,57,75,0],[77,38,77,75,0]]);
    </script>
  </body>
</html>