<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\projects\zenwire\zenwire\filters\initializesimplemembershipattribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data.Entity;
using System.Data.Entity.Infrastructure;
using System.Diagnostics.CodeAnalysis;
using System.Threading;
using System.Web.Mvc;
using WebMatrix.WebData;
using Zenwire.Repositories;

namespace Zenwire.Filters
{
    [ExcludeFromCodeCoverage]
    [AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, AllowMultiple = false, Inherited = true)]
    public sealed class InitializeSimpleMembershipAttribute : ActionFilterAttribute
    {
        private static SimpleMembershipInitializer _initializer;
        private static object _initializerLock = new object();
        private static bool _isInitialized;

        public override void OnActionExecuting(ActionExecutingContext filterContext)
        {
            // Ensure ASP.NET Simple Membership is initialized only once per app start
            LazyInitializer.EnsureInitialized(ref _initializer, ref _isInitialized, ref _initializerLock);
        }

        private class SimpleMembershipInitializer
        {
            public SimpleMembershipInitializer()
            {
                Database.SetInitializer&lt;ZenwireContext&gt;(null);

                try
                {
                    using (var context = new ZenwireContext())
                    {
                        if (!context.Database.Exists())
                        {
                            // Create the SimpleMembership database without Entity Framework migration schema
                            ((IObjectContextAdapter)context).ObjectContext.CreateDatabase();
                        }
                    }

                    WebSecurity.InitializeDatabaseConnection(&quot;Repositories.ZenwireContext&quot;, &quot;UserProfile&quot;, &quot;Id&quot;, &quot;UserName&quot;, true);
                }
                catch (Exception ex)
                {
                    throw new InvalidOperationException(&quot;The ASP.NET Simple Membership database could not be initialized. For more information, please see http://go.microsoft.com/fwlink/?LinkId=256588&quot;, ex);
                }
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,10,0],[23,13,23,107,0],[24,9,24,10,0],[17,9,17,63,0],[28,13,28,49,0],[29,13,29,14,0],[30,17,30,63,0],[33,17,33,18,0],[34,28,34,62,0],[35,21,35,22,0],[36,25,36,56,0],[37,25,37,26,0],[39,29,39,93,0],[40,25,40,26,0],[41,21,41,22,0],[43,21,43,132,0],[44,17,44,18,0],[45,17,45,37,0],[46,17,46,18,0],[47,21,47,208,0],[49,13,49,14,0]]);
    </script>
  </body>
</html>