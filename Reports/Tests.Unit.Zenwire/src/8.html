<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\projects\zenwire\zenwire\controllers\accountcontroller.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Transactions;
using System.Web.Mvc;
using System.Web.Security;
using DotNetOpenAuth.AspNet;
using Microsoft.Web.WebPages.OAuth;
using WebMatrix.WebData;
using Zenwire.Domain;
using Zenwire.Filters;
using Zenwire.Models;
using Zenwire.Repositories;

namespace Zenwire.Controllers
{
    [ExcludeFromCodeCoverage]
    [Authorize]
    [InitializeSimpleMembership]
    public class AccountController : Controller
    {
        //
        // GET: /Account/Login

        [AllowAnonymous]
        public ActionResult Login(string returnUrl)
        {
            ViewBag.ReturnUrl = returnUrl;
            return View();
        }

        //
        // POST: /Account/Login

        [HttpPost]
        [AllowAnonymous]
        [ValidateAntiForgeryToken]
        public ActionResult Login(LoginModel model, string returnUrl)
        {
            if (ModelState.IsValid &amp;&amp; WebSecurity.Login(model.UserName, model.Password, persistCookie: model.RememberMe))
            {
                return RedirectToLocal(returnUrl);
            }

            // If we got this far, something failed, redisplay form
            ModelState.AddModelError(&quot;&quot;, &quot;The user name or password provided is incorrect.&quot;);
            return View(model);
        }

        //
        // POST: /Account/LogOff

        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult LogOff()
        {
            WebSecurity.Logout();

            return RedirectToAction(&quot;Index&quot;, &quot;Home&quot;);
        }

        //
        // GET: /Account/Register

        [AllowAnonymous]
        public ActionResult Register()
        {
            return View();
        }

        //
        // POST: /Account/Register

        [HttpPost]
        [AllowAnonymous]
        [ValidateAntiForgeryToken]
        public ActionResult Register(RegisterModel model)
        {
            if (ModelState.IsValid)
            {
                // Attempt to register the user
                try
                {
                    WebSecurity.CreateUserAndAccount(model.UserName, model.Password);
                    WebSecurity.Login(model.UserName, model.Password);
                    return RedirectToAction(&quot;Index&quot;, &quot;Home&quot;);
                }
                catch (MembershipCreateUserException e)
                {
                    ModelState.AddModelError(&quot;&quot;, ErrorCodeToString(e.StatusCode));
                }
            }

            // If we got this far, something failed, redisplay form
            return View(model);
        }

        //
        // POST: /Account/Disassociate

        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Disassociate(string provider, string providerUserId)
        {
            string ownerAccount = OAuthWebSecurity.GetUserName(provider, providerUserId);
            ManageMessageId? message = null;

            // Only disassociate the account if the currently logged in user is the owner
            if (ownerAccount == User.Identity.Name)
            {
                // Use a transaction to prevent the user from deleting their last login credential
                using (var scope = new TransactionScope(TransactionScopeOption.Required, new TransactionOptions { IsolationLevel = IsolationLevel.Serializable }))
                {
                    bool hasLocalAccount = OAuthWebSecurity.HasLocalAccount(WebSecurity.GetUserId(User.Identity.Name));
                    if (hasLocalAccount || OAuthWebSecurity.GetAccountsFromUserName(User.Identity.Name).Count &gt; 1)
                    {
                        OAuthWebSecurity.DeleteAccount(provider, providerUserId);
                        scope.Complete();
                        message = ManageMessageId.RemoveLoginSuccess;
                    }
                }
            }

            return RedirectToAction(&quot;Manage&quot;, new { Message = message });
        }

        //
        // GET: /Account/Manage

        public ActionResult Manage(ManageMessageId? message)
        {
            ViewBag.StatusMessage =
                message == ManageMessageId.ChangePasswordSuccess ? &quot;Your password has been changed.&quot;
                : message == ManageMessageId.SetPasswordSuccess ? &quot;Your password has been set.&quot;
                : message == ManageMessageId.RemoveLoginSuccess ? &quot;The external login was removed.&quot;
                : &quot;&quot;;
            ViewBag.HasLocalPassword = OAuthWebSecurity.HasLocalAccount(WebSecurity.GetUserId(User.Identity.Name));
            ViewBag.ReturnUrl = Url.Action(&quot;Manage&quot;);
            return View();
        }

        //
        // POST: /Account/Manage

        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Manage(LocalPasswordModel model)
        {
            bool hasLocalAccount = OAuthWebSecurity.HasLocalAccount(WebSecurity.GetUserId(User.Identity.Name));
            ViewBag.HasLocalPassword = hasLocalAccount;
            ViewBag.ReturnUrl = Url.Action(&quot;Manage&quot;);
            if (hasLocalAccount)
            {
                if (ModelState.IsValid)
                {
                    // ChangePassword will throw an exception rather than return false in certain failure scenarios.
                    bool changePasswordSucceeded;
                    try
                    {
                        changePasswordSucceeded = WebSecurity.ChangePassword(User.Identity.Name, model.OldPassword, model.NewPassword);
                    }
                    catch (Exception)
                    {
                        changePasswordSucceeded = false;
                    }

                    if (changePasswordSucceeded)
                    {
                        return RedirectToAction(&quot;Manage&quot;, new { Message = ManageMessageId.ChangePasswordSuccess });
                    }
                    else
                    {
                        ModelState.AddModelError(&quot;&quot;, &quot;The current password is incorrect or the new password is invalid.&quot;);
                    }
                }
            }
            else
            {
                // User does not have a local password so remove any validation errors caused by a missing
                // OldPassword field
                ModelState state = ModelState[&quot;OldPassword&quot;];
                if (state != null)
                {
                    state.Errors.Clear();
                }

                if (ModelState.IsValid)
                {
                    try
                    {
                        WebSecurity.CreateAccount(User.Identity.Name, model.NewPassword);
                        return RedirectToAction(&quot;Manage&quot;, new { Message = ManageMessageId.SetPasswordSuccess });
                    }
                    catch (Exception)
                    {
                        ModelState.AddModelError(&quot;&quot;, String.Format(&quot;Unable to create local account. An account with the name \&quot;{0}\&quot; may already exist.&quot;, User.Identity.Name));
                    }
                }
            }

            // If we got this far, something failed, redisplay form
            return View(model);
        }

        //
        // POST: /Account/ExternalLogin

        [HttpPost]
        [AllowAnonymous]
        [ValidateAntiForgeryToken]
        public ActionResult ExternalLogin(string provider, string returnUrl)
        {
            return new ExternalLoginResult(provider, Url.Action(&quot;ExternalLoginCallback&quot;, new { ReturnUrl = returnUrl }));
        }

        //
        // GET: /Account/ExternalLoginCallback

        [AllowAnonymous]
        public ActionResult ExternalLoginCallback(string returnUrl)
        {
            AuthenticationResult result = OAuthWebSecurity.VerifyAuthentication(Url.Action(&quot;ExternalLoginCallback&quot;, new { ReturnUrl = returnUrl }));
            if (!result.IsSuccessful)
            {
                return RedirectToAction(&quot;ExternalLoginFailure&quot;);
            }

            if (OAuthWebSecurity.Login(result.Provider, result.ProviderUserId, createPersistentCookie: false))
            {
                return RedirectToLocal(returnUrl);
            }

            if (User.Identity.IsAuthenticated)
            {
                // If the current user is logged in add the new account
                OAuthWebSecurity.CreateOrUpdateAccount(result.Provider, result.ProviderUserId, User.Identity.Name);
                return RedirectToLocal(returnUrl);
            }
            else
            {
                // User is new, ask for their desired membership name
                string loginData = OAuthWebSecurity.SerializeProviderUserId(result.Provider, result.ProviderUserId);
                ViewBag.ProviderDisplayName = OAuthWebSecurity.GetOAuthClientData(result.Provider).DisplayName;
                ViewBag.ReturnUrl = returnUrl;
                return View(&quot;ExternalLoginConfirmation&quot;, new RegisterExternalLoginModel { UserName = result.UserName, ExternalLoginData = loginData });
            }
        }

        //
        // POST: /Account/ExternalLoginConfirmation

        [HttpPost]
        [AllowAnonymous]
        [ValidateAntiForgeryToken]
        public ActionResult ExternalLoginConfirmation(RegisterExternalLoginModel model, string returnUrl)
        {
            string provider = null;
            string providerUserId = null;

            if (User.Identity.IsAuthenticated || !OAuthWebSecurity.TryDeserializeProviderUserId(model.ExternalLoginData, out provider, out providerUserId))
            {
                return RedirectToAction(&quot;Manage&quot;);
            }

            if (ModelState.IsValid)
            {
                // Insert a new user into the database
                using (var db = new ZenwireContext())
                {
                    UserProfile user = db.UserProfiles.FirstOrDefault(u =&gt; u.UserName.ToLower() == model.UserName.ToLower());
                    // Check if user already exists
                    if (user == null)
                    {
                        // Insert name into the profile table
                        db.UserProfiles.Add(new UserProfile { UserName = model.UserName });
                        db.SaveChanges();

                        OAuthWebSecurity.CreateOrUpdateAccount(provider, providerUserId, model.UserName);
                        OAuthWebSecurity.Login(provider, providerUserId, createPersistentCookie: false);

                        return RedirectToLocal(returnUrl);
                    }
                    else
                    {
                        ModelState.AddModelError(&quot;UserName&quot;, &quot;User name already exists. Please enter a different user name.&quot;);
                    }
                }
            }

            ViewBag.ProviderDisplayName = OAuthWebSecurity.GetOAuthClientData(provider).DisplayName;
            ViewBag.ReturnUrl = returnUrl;
            return View(model);
        }

        //
        // GET: /Account/ExternalLoginFailure

        [AllowAnonymous]
        public ActionResult ExternalLoginFailure()
        {
            return View();
        }

        [AllowAnonymous]
        [ChildActionOnly]
        public ActionResult ExternalLoginsList(string returnUrl)
        {
            ViewBag.ReturnUrl = returnUrl;
            return PartialView(&quot;_ExternalLoginsListPartial&quot;, OAuthWebSecurity.RegisteredClientData);
        }

        [ChildActionOnly]
        public ActionResult RemoveExternalLogins()
        {
            ICollection&lt;OAuthAccount&gt; accounts = OAuthWebSecurity.GetAccountsFromUserName(User.Identity.Name);
            List&lt;ExternalLogin&gt; externalLogins = new List&lt;ExternalLogin&gt;();
            foreach (OAuthAccount account in accounts)
            {
                AuthenticationClientData clientData = OAuthWebSecurity.GetOAuthClientData(account.Provider);

                externalLogins.Add(new ExternalLogin
                {
                    Provider = account.Provider,
                    ProviderDisplayName = clientData.DisplayName,
                    ProviderUserId = account.ProviderUserId,
                });
            }

            ViewBag.ShowRemoveButton = externalLogins.Count &gt; 1 || OAuthWebSecurity.HasLocalAccount(WebSecurity.GetUserId(User.Identity.Name));
            return PartialView(&quot;_RemoveExternalLoginsPartial&quot;, externalLogins);
        }

        #region Helpers
        private ActionResult RedirectToLocal(string returnUrl)
        {
            if (Url.IsLocalUrl(returnUrl))
            {
                return Redirect(returnUrl);
            }
            else
            {
                return RedirectToAction(&quot;Index&quot;, &quot;Home&quot;);
            }
        }

        public enum ManageMessageId
        {
            ChangePasswordSuccess,
            SetPasswordSuccess,
            RemoveLoginSuccess,
        }

        internal class ExternalLoginResult : ActionResult
        {
            public ExternalLoginResult(string provider, string returnUrl)
            {
                Provider = provider;
                ReturnUrl = returnUrl;
            }

            public string Provider { get; private set; }
            public string ReturnUrl { get; private set; }

            public override void ExecuteResult(ControllerContext context)
            {
                OAuthWebSecurity.RequestAuthentication(Provider, ReturnUrl);
            }
        }

        private static string ErrorCodeToString(MembershipCreateStatus createStatus)
        {
            // See http://go.microsoft.com/fwlink/?LinkID=177550 for
            // a full list of status codes.
            switch (createStatus)
            {
                case MembershipCreateStatus.DuplicateUserName:
                    return &quot;User name already exists. Please enter a different user name.&quot;;

                case MembershipCreateStatus.DuplicateEmail:
                    return &quot;A user name for that e-mail address already exists. Please enter a different e-mail address.&quot;;

                case MembershipCreateStatus.InvalidPassword:
                    return &quot;The password provided is invalid. Please enter a valid password value.&quot;;

                case MembershipCreateStatus.InvalidEmail:
                    return &quot;The e-mail address provided is invalid. Please check the value and try again.&quot;;

                case MembershipCreateStatus.InvalidAnswer:
                    return &quot;The password retrieval answer provided is invalid. Please check the value and try again.&quot;;

                case MembershipCreateStatus.InvalidQuestion:
                    return &quot;The password retrieval question provided is invalid. Please check the value and try again.&quot;;

                case MembershipCreateStatus.InvalidUserName:
                    return &quot;The user name provided is invalid. Please check the value and try again.&quot;;

                case MembershipCreateStatus.ProviderError:
                    return &quot;The authentication provider returned an error. Please verify your entry and try again. If the problem persists, please contact your system administrator.&quot;;

                case MembershipCreateStatus.UserRejected:
                    return &quot;The user creation request has been canceled. Please verify your entry and try again. If the problem persists, please contact your system administrator.&quot;;

                default:
                    return &quot;An unknown error occurred. Please verify your entry and try again. If the problem persists, please contact your system administrator.&quot;;
            }
        }
        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,0],[29,13,29,43,0],[30,13,30,27,0],[31,9,31,10,0],[40,9,40,10,0],[41,13,41,122,0],[42,13,42,14,0],[43,17,43,51,0],[47,13,47,94,0],[48,13,48,32,0],[49,9,49,10,0],[57,9,57,10,0],[58,13,58,34,0],[60,13,60,54,0],[61,9,61,10,0],[68,9,68,10,0],[69,13,69,27,0],[70,9,70,10,0],[79,9,79,10,0],[80,13,80,36,0],[81,13,81,14,0],[84,17,84,18,0],[85,21,85,86,0],[86,21,86,71,0],[87,21,87,62,0],[89,17,89,56,0],[90,17,90,18,0],[91,21,91,83,0],[92,17,92,18,0],[93,13,93,14,0],[96,13,96,32,0],[97,9,97,10,0],[105,9,105,10,0],[106,13,106,90,0],[107,13,107,45,0],[110,13,110,52,0],[111,13,111,14,0],[113,24,113,162,0],[114,17,114,18,0],[115,21,115,120,0],[116,21,116,115,0],[117,21,117,22,0],[118,25,118,82,0],[119,25,119,42,0],[120,25,120,70,0],[121,21,121,22,0],[122,17,122,18,0],[123,13,123,14,0],[125,13,125,74,0],[126,9,126,10,0],[132,9,132,10,0],[133,13,137,22,0],[138,13,138,116,0],[139,13,139,54,0],[140,13,140,27,0],[141,9,141,10,0],[149,9,149,10,0],[150,13,150,112,0],[151,13,151,56,0],[152,13,152,54,0],[153,13,153,33,0],[154,13,154,14,0],[155,17,155,40,0],[156,17,156,18,0],[160,21,160,22,0],[161,25,161,136,0],[162,21,162,22,0],[163,21,163,38,0],[164,21,164,22,0],[165,25,165,57,0],[166,21,166,22,0],[168,21,168,49,0],[169,21,169,22,0],[170,25,170,116,0],[173,21,173,22,0],[174,25,174,123,0],[175,21,175,22,0],[176,17,176,18,0],[177,13,177,14,0],[179,13,179,14,0],[182,17,182,62,0],[183,17,183,35,0],[184,17,184,18,0],[185,21,185,42,0],[186,17,186,18,0],[188,17,188,40,0],[189,17,189,18,0],[191,21,191,22,0],[192,25,192,90,0],[193,25,193,113,0],[195,21,195,38,0],[196,21,196,22,0],[197,25,197,176,0],[198,21,198,22,0],[199,17,199,18,0],[200,13,200,14,0],[203,13,203,32,0],[204,9,204,10,0],[213,9,213,10,0],[214,13,214,122,0],[215,9,215,10,0],[222,9,222,10,0],[223,13,223,149,0],[224,13,224,38,0],[225,13,225,14,0],[226,17,226,65,0],[229,13,229,111,0],[230,13,230,14,0],[231,17,231,51,0],[234,13,234,47,0],[235,13,235,14,0],[237,17,237,116,0],[238,17,238,51,0],[241,13,241,14,0],[243,17,243,117,0],[244,17,244,112,0],[245,17,245,47,0],[246,17,246,152,0],[248,9,248,10,0],[257,9,257,10,0],[258,13,258,36,0],[259,13,259,42,0],[261,13,261,156,0],[262,13,262,14,0],[263,17,263,51,0],[266,13,266,36,0],[267,13,267,14,0],[269,24,269,53,0],[270,17,270,18,0],[271,21,271,126,0],[273,21,273,38,0],[274,21,274,22,0],[276,25,276,92,0],[277,25,277,42,0],[279,25,279,106,0],[280,25,280,105,0],[282,25,282,59,0],[285,21,285,22,0],[286,25,286,127,0],[287,21,287,22,0],[288,17,288,18,0],[289,13,289,14,0],[291,13,291,101,0],[292,13,292,43,0],[293,13,293,32,0],[294,9,294,10,0],[301,9,301,10,0],[302,13,302,27,0],[303,9,303,10,0],[308,9,308,10,0],[309,13,309,43,0],[310,13,310,101,0],[311,9,311,10,0],[315,9,315,10,0],[316,13,316,111,0],[317,13,317,76,0],[318,13,318,20,0],[318,46,318,54,0],[318,22,318,42,0],[319,13,319,14,0],[320,17,320,109,0],[322,17,327,20,0],[328,13,328,14,0],[318,43,318,45,0],[330,13,330,144,0],[331,13,331,80,0],[332,9,332,10,0],[336,9,336,10,0],[337,13,337,43,0],[338,13,338,14,0],[339,17,339,44,0],[342,13,342,14,0],[343,17,343,58,0],[345,9,345,10,0],[372,9,372,10,0],[375,13,375,34,0],[378,21,378,92,0],[381,21,381,123,0],[384,21,384,101,0],[387,21,387,108,0],[390,21,390,119,0],[393,21,393,121,0],[396,21,396,103,0],[399,21,399,184,0],[402,21,402,182,0],[405,21,405,164,0],[407,9,407,10,0],[356,13,356,74,0],[357,13,357,14,0],[358,17,358,37,0],[359,17,359,39,0],[360,13,360,14,0],[366,13,366,14,0],[367,17,367,77,0],[368,13,368,14,0]]);
    </script>
  </body>
</html>